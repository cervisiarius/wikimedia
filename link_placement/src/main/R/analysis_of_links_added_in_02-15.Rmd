---
title: "Analysis of added links"
author: "Bob West"
date: "07/01/2015"
output: html_document
---

# Load the data and beat it into shape

```{r}
.default_par <- par(no.readonly=TRUE)

DATADIR <- sprintf('%s/wikimedia/trunk/data/link_placement/', Sys.getenv('HOME'))

data <- read.table(pipe(sprintf('gunzip -c %s/links_added_in_02-15_WITH-STATS.tsv.gz', DATADIR)),
                   header=TRUE, quote='', sep='\t')
data[,1] <- paste(data$src, data$tgt)
data <- data[,-2]
colnames(data)[1] <- 'cand'

data_orig <- data

data$num_wiki_searches_before <- data$num_wiki_searches_302_before + data$num_wiki_searches_200_before
data$num_wiki_searches_after <- data$num_wiki_searches_302_after + data$num_wiki_searches_200_after

# Status-302 searches are counted as direct clicks in the input data, so correct for this.
# Q: WHY is sum(data$num_wiki_searches_302_before > data$num_clicks_before) == 1362, not 0?
# A: Maybe if the browser somehow fires several 302 search requests but only one 200 forward
# to the article.
data$num_clicks_before <- pmax(0, data$num_clicks_before - data$num_wiki_searches_302_before)
data$num_clicks_after <- pmax(0, data$num_clicks_after - data$num_wiki_searches_302_after)

# Remove those that still have direct clicks before, which are most probably from links embedded
# into templates.
data <- data[data$num_clicks_before == 0,]

# Compute the direct-click probabilities.
data$click_prob_before <- data$num_clicks_before / data$num_paths_before
data$click_prob_after <- data$num_clicks_after / data$num_paths_after

# Compute the search probabilities.
data$search_prob_ext_before <- data$num_external_searches_before / (data$num_external_searches_before + data$num_paths_before)
# Path counts already include 302 searches, so we just need to add the 200 searches in the denominator.
data$search_prob_wiki_before <- data$num_wiki_searches_before / (data$num_paths_before + data$num_wiki_searches_200_before)
data$search_prob_all_before <- (data$num_external_searches_before + data$num_wiki_searches_before) /
  (data$num_external_searches_before + data$num_paths_before + data$num_wiki_searches_200_before)
data$search_prob_ext_after <- data$num_external_searches_after / (data$num_external_searches_after + data$num_paths_after)
# Path counts already include 302 searches, so we just need to add the 200 searches in the denominator.
data$search_prob_wiki_after <- data$num_wiki_searches_after / (data$num_paths_after + data$num_wiki_searches_200_after)
data$search_prob_all_after <- (data$num_external_searches_after + data$num_wiki_searches_after) /
  (data$num_external_searches_after + data$num_paths_after + data$num_wiki_searches_200_after)

# Currently the data is only accurate for the cases where both #paths_before and #paths_after is
# greater than 0; if only one of them is greater than 0, then both will appear as 0 (consequence
# of how Ashwin extracted the data).
# So here we can only analyze pairs that were active both before and after.
active <- data[data$num_paths_before >= 5 & data$num_paths_after >= 5,]
```

# Usage of newly added links

```{r}
# A scatter plot of the number of paths before vs. after (incl. direct clicks after).
# We jitter the data to spread the overlay at low values.
x <- jitter(data$num_paths_before[data$num_paths_before > 0 & data$num_paths_after > 0], amount=0.5)
y <- jitter(data$num_paths_after[data$num_paths_before > 0 & data$num_paths_after > 0], amount=0.5)
plot(x, y, col='#00000005', pch=16, log='xy', xlim=range(c(x,y)), ylim=range(c(x,y)),
     xlab='Num paths before', ylab='Num paths after (direct and indirect)')
abline(0,1, col='red')

# Now consider indirect paths only. Here, the data is much closer to the diagonal, which means that
# the increased volume in transitions from s to t comes mostly from direct link clicks.
# The number of indirect paths does not seem to decrease after the link is added.
x_raw <- data$num_paths_before
y_raw <- data$num_paths_after - data$num_clicks_after
x <- jitter(x_raw[x_raw > 0 & y_raw > 0], amount=0.5)
y <- jitter(y_raw[x_raw > 0 & y_raw > 0], amount=0.5)
plot(x, y, col='#00000005', pch=16, log='xy', xlim=range(c(x,y)), ylim=range(c(x,y)),
     xlab='Num paths before', ylab='Num paths after (indirect only)')
abline(0,1, col='red')

# No indirect before but indirect after.
# TODO: check: possibly because s or t was created simultaneously with link?
sum(x_raw == 0 & y_raw > 0)
# Indirect before but no indirect after.
sum(x_raw > 0 & y_raw == 0)

# Let's also subtract 
# x_raw <- data$num_paths_before
# y_raw <- data$num_paths_after - data$num_wiki_searches_after - data$num_clicks_after 
# x <- jitter(x_raw[x_raw > 0 & y_raw > 0], amount=0.5)
# y <- jitter(y_raw[x_raw > 0 & y_raw > 0], amount=0.5)
# plot(x, y, col='#00000005', pch=16, log='xy', xlim=range(c(x,y)), ylim=range(c(x,y)),
#      xlab='Num paths before', ylab='Num paths after (indirect only)')
# abline(0,1, col='red')




# Most clicks are not used at all (73%); among the rest, there's a long tail, with only few links
# used frequently. Only 1% gets used more than 100 times in the month of March.
plot(sort(data$num_clicks_after), (nrow(data):1)/nrow(data), log='xy', type='l', panel.first=grid(),
     xlab='Mininum number of clicks', ylab='Fraction of new links')
frac_1 <- sum(data$num_clicks_after>0)/nrow(data)
abline(h=frac_1)
text(1000, frac_1, sprintf('No clicks: %.0f%%', frac_0*100), pos=3)
text(1000, frac_1, sprintf('At least one click: %.0f%%', (1-frac_0)*100), pos=1)

# The fact that links get used so rarely might come simply from the fact that
```

# Search as a predictor of link usage

```{r}
# Order the candidates by their search proportions before the links are added.
ord_ext <- order(active$search_prob_ext_before, decreasing=TRUE)
ord_wiki <- order(active$search_prob_wiki_before, decreasing=TRUE)
ord_all <- order(active$search_prob_all_before, decreasing=TRUE)

x_wiki <- active$search_prob_wiki_before[ord_wiki]
x_ext <- active$search_prob_ext_before[ord_ext]
x_all <- active$search_prob_all_before[ord_all]

y_wiki <- active$click_prob_after[ord_wiki]
y_ext <- active$click_prob_after[ord_ext]
y_all <- active$click_prob_after[ord_all]

# Randomize the order of the candidates with search scores of 0, to be sure to eliminate any
# external bias among those equally ranked candidates.
idx <- which(x_wiki==0);  y_wiki[idx] <- y_wiki[idx[sample(length(idx), length(idx))]]
idx <- which(x_ext==0);   y_ext[idx] <- y_ext[idx[sample(length(idx), length(idx))]]
idx <- which(x_all==0);   y_all[idx] <- y_all[idx[sample(length(idx), length(idx))]]

# A scatter plot of search proportion vs. link usage.
plot(1:nrow(active), y_all, col='#00000005', pch=16, cex=2, xlim=c(0,10000),
     xlab='Rank w.r.t. search proportion (Jan 15)', ylab='Proportion of direct clicks (Mar 15)',
     main='All searches')
abline(v=min(which(x_all==0)))

# It's hard to see what's going on in this raw scatter plot, so let's smooth it.
smooth <- function(y) ksmooth(1:length(y), y, bandwidth=50, kernel='normal')$y

draw_search_rank_vs_usage_smoothed <- function(x, y, type, col) {
  xmax <- 1e4
  plot(smooth(y), type='l', col=col, xlim=c(0,xmax),
       main=sprintf('%s as a predictor of link quality', type),
       xlab='Rank w.r.t. search proportion (Jan 15)', ylab='Proportion of direct clicks (Mar 15)')
  x0 <- min(which(x==0))
  abline(v=x0)
  text(x0/2, 0.8, 'At least\none search')
  text((x0+xmax)/2, 0.8, 'No search')  
}

draw_search_rank_vs_usage_smoothed(x_all, y_all, 'Search', 'black')
draw_search_rank_vs_usage_smoothed(x_wiki, y_wiki, 'Wiki search', 'green')
draw_search_rank_vs_usage_smoothed(x_ext, y_ext, 'External search', 'red')

# Let's draw the same plots again, but instead of rank, we use the actual value that's used for
# ranking on the x-axis.
draw_search_prop_vs_usage_smoothed <- function(x, y, type, col) {
  plot(x, smooth(y), type='l', col=col, xlim=c(0.005, 1), log='x',
       main=sprintf('%s as a predictor of link quality', type),
       xlab='Search proportion (Jan 15)', ylab='Proportion of direct clicks (Mar 15)')
  rug(jitter(x), col='#00000050')
#   dens_log <- density(log(x[x>0]))
#   x_dens <- exp(dens_log$x)
#   y_dens <- dens_log$y
#   lines(x_dens, (y_dens-min(y_dens))/(max(y_dens)-min(y_dens))*0.05+0.45)
}

draw_search_prop_vs_usage_smoothed(x_all, y_all, 'Search', 'black')
draw_search_prop_vs_usage_smoothed(x_wiki, y_wiki, 'Wiki search', 'green')
draw_search_prop_vs_usage_smoothed(x_ext, y_ext, 'External search', 'red')

# Next, let's consider a quality measure that always evaluates the entire top of the ranking up to
# a given rank. We plot rank vs. the average direct-click probability of the items above that rank.
draw_search_rank_vs_avg_usage <- function(x, y, type, col) {
  xmax <- 1e4
  plot(cumsum(y)/(1:length(y)), type='l', col=col, xlim=c(0,xmax), ylim=c(0.6,1),
       main=sprintf('%s as a predictor of link quality', type),
       xlab='Rank w.r.t. search proportion (Jan 15)', ylab='Avg. proportion of direct clicks (Mar 15)')
  x0 <- min(which(x==0))
  abline(v=x0)
  text(x0/2, 0.9, 'At least\none search')
  text((x0+xmax)/2, 0.9, 'No search')  
}

draw_search_rank_vs_avg_usage(x_all, y_all, 'Search', 'black')
draw_search_rank_vs_avg_usage(x_wiki, y_wiki, 'Wiki search', 'green')
draw_search_rank_vs_avg_usage(x_ext, y_ext, 'External search', 'red')
```

# Change in search volume after link introduction

```{r}
search_diff_boxplot <- function(search_prob_before, search_prob_after) {
  diff <- ((search_prob_after - search_prob_before) / search_prob_before)[search_prob_before > 0]
  #diff <- ((search_prob_after - search_prob_before) / search_prob_before)[search_prob_before > 0 & search_prob_after > 0]
  #diff <- (search_prob_after - search_prob_before)[search_prob_before > 0]
  boxplot(diff, ylim=c(-1,1), main=length(diff))
  abline(h=0, col='gray')
}

search_diff_boxplot(active$search_prob_wiki_before, active$search_prob_wiki_after)
search_diff_boxplot(active$search_prob_ext_before, active$search_prob_ext_after)
search_diff_boxplot(active$search_prob_all_before, active$search_prob_all_after)

# The following scatter plot also shows that the search proportion decreases when the link is added.
# NB: log axes.
idx <- which(active$search_prob_all_before > 0)
plot(active$search_prob_all_before[idx], active$search_prob_all_after[idx],
     col='#00000010', pch=16, xlim=c(0.001,1), ylim=c(0.001,1), cex=2, log='xy',
     xlab='Search proportion (Jan 15)', ylab='Search proportion (Mar 15)')
abline(0,1)
```

