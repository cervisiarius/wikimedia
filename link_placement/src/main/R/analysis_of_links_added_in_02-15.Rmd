---
title: "Analysis of added links"
author: "Bob West"
date: "07/01/2015"
output: html_document
---


```{r}
.default_par <- par(no.readonly=TRUE)

DATADIR <- sprintf('%s/wikimedia/trunk/data/link_placement/', Sys.getenv('HOME'))

data <- read.table(pipe(sprintf('gunzip -c %s/links_added_in_02-15_WITH-STATS.tsv.gz', DATADIR)),
                   header=TRUE, quote='', sep='\t')
data[,1] <- paste(data$src, data$tgt)
data <- data[,-2]
colnames(data)[1] <- 'cand'

data_orig <- data

data$num_wiki_searches_before <- data$num_wiki_searches_302_before + data$num_wiki_searches_200_before
data$num_wiki_searches_after <- data$num_wiki_searches_302_after + data$num_wiki_searches_200_after

# Status-302 searches are counted as direct clicks in the input data, so correct for this.
### WHY is sum(data$num_wiki_searches_302_before > data$num_clicks_before) == 1362, not 0?
data$num_clicks_before <- pmax(0, data$num_clicks_before - data$num_wiki_searches_302_before)
data$num_clicks_after <- pmax(0, data$num_clicks_after - data$num_wiki_searches_302_after)

# Remove those that still have direct clicks before, which are most probably from links embedded
# into templates.
data <- data[data$num_clicks_before == 0,]

# Compute the direct-click probabilities.
data$click_prob_before <- data$num_clicks_before / data$num_paths_before
data$click_prob_after <- data$num_clicks_after / data$num_paths_after

# TODO: num_wiki_searches is also sometimes larger than num_paths

# Currently the data is only accurate for the cases where both #paths_before and #paths_after is
# greater than 0; if only one of them is greater than 0, then both will appear as 0 (consequence
# of how Ashwin extracted the data).
# So here we can only analyze pairs that were active both before and after.
active <- data[data$num_paths_before >= 5 & data$num_paths_after >= 5,]

x_ext <- active$num_external_searches_before / (active$num_external_searches_before + active$num_paths_before)
x_wiki <- active$num_wiki_searches_before / (active$num_paths_before + active$num_wiki_searches_200_before)
ord_ext <- order(x_ext, decreasing=TRUE)
ord_wiki <- order(x_wiki, decreasing=TRUE)
plot(1:nrow(active), active$click_prob_after[ord_ext], col='#00000005', pch=16)

#####################
plot(cumsum(active$click_prob_after[ord_wiki])/(1:nrow(active)), type='l', col='red', xlim=c(0,5000))
abline(v=min(which(x_wiki[ord_wiki]==0)), col='red')
lines(cumsum(active$click_prob_after[ord_ext])/(1:nrow(active)))
abline(v=min(which(x_ext[ord_ext]==0)))

smooth <- function(y) ksmooth(1:length(y), y, bandwidth=100, kernel='normal')$y
plot(smooth(active$click_prob_after[ord_wiki]), type='l', col='red', xlim=c(0,5000))
abline(v=min(which(x_wiki[ord_wiki]==0)), col='red')
lines(smooth(active$click_prob_after[ord_ext]))
abline(v=min(which(x_ext[ord_ext]==0)))

plot(x_wiki[ord_wiki], smooth(active$click_prob_after[ord_wiki]), type='l', col='red', ylim=c(0.5,1), xlim=c(0,1))
lines(x_ext[ord_ext], smooth(active$click_prob_after[ord_ext]))


plot(active$num_paths_before, active$num_clicks_after/active$num_paths_after, log='x', col='#00000005', pch=16)
lowess <- lowess(log(active$num_paths_before), log(active$num_clicks_after/active$num_paths_after))
lines(exp(lowess$x), exp(lowess$y), col='red')

groups <- cut(active$num_paths_before, c(1,10,100,1000,10000))
boxplot(active$num_clicks_after/active$num_paths_after ~ groups)




sgn <- sign(num_wiki_searches_after - num_wiki_searches_before)
barplot(tapply(sgn, sgn, length))

sgn <- sign(active$num_external_searches_after - active$num_external_searches_before)
barplot(tapply(sgn, sgn, length))

```

